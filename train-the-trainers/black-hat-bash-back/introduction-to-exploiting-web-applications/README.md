# Introduction to Exploiting Web Applications

According to [Douglas Crockford](https://crockford.com/), former distinguished architect of Internet behemoths PayPal and Yahoo! before that, &ldquo;The Web is the most hostile software engineering environment imaginable.&rdquo; Given that it&rsquo;s hard enough to make Web applications work in the first place, is it any surprise that so many of them can be broken, hacked, and exploited? Of course, it&rsquo;s often not good enough merely to break some system. Our task is to make the system break in *specific* ways that will be useful to us.

This exercise will introduce you to the [OWASP Zed Attack Proxy (ZAP)](https://www.zaproxy.org/), a free and open source Web application security scanner. We&rsquo;ll cover Web application security basics, including ZAP&rsquo;s configuration, target scoping, and more. We&rsquo;ll be targeting the [OWASP Juice Shop](https://owasp.org/www-project-juice-shop/), an intentionally vulnerable practice target that has a slew of common Web vulnerabilities to learn about. The most common of these vulnerabilities are collectively known as the [OWASP Top Ten](https://owasp.org/www-project-top-ten/). They include SQL injection, sensitive data exposure, cross-site scripting (XSS), broken authentication and access control, and many others.

Today&rsquo;s World Wide Web has become a worldwide battleground, economically, militarily, and culturally. By knowing how the Web-based systems we all use&mdash;or even build!&mdash;can be made to fail in just the &ldquo;right&rdquo; way, we can better protect ourselves and our organizations from the constant barrage of attacks flying across the Internet. This exercise provides an opportunity to learn how to hack your own Web sites and applications before your opponents do so you can find your own vulnerabilities and shore up your own defenses before your adversaries get the chance to exploit them.

# Contents

1. [Objectives](#objectives)
1. [Bill of materials](#bill-of-materials)
1. [Prerequisites](#prerequisites)
1. [Set up](#set-up)
1. [Practice](#practice)
    1. [Introduction](#introduction)
1. [Discussion](#discussion)
1. [Additional references](#additional-references)

# Objectives

> :construction: TK-TODO

# Bill of materials

This folder contains the following files and folders:

* `Blue Team/` - Git submodule that should contain the OWASP Juice Shop source code. If this directory is empty, be sure you have fetched this repository's submodule contents by running `git submodule update --init`.
* `README.md` - This file.
* `Red Team/` - Provisioning files for the attacker machine.
* `Vagrantfile` - The Vagrant configuration for our practice target (the &ldquo;Blue Team,&rdquo; which in this case is an [OWASP Juice Shop](https://owasp.org/www-project-juice-shop/) instance), and our attacker machine.

# Prerequisites

To perform this lab, you must have:

* A computer running any modern version of:
    * Windows,
    * macOS,
    * FreeBSD,
    * Solaris, or
    * any flavor of the GNU/Linux operating system.
* An active Internet connection (for downloading the required tools in the [set up](#set-up) step, as well as Vagrant base boxes, and the required software packages into the virtual machines; you do not need an Internet connection once you have completed the set up portion of this lab).

> :beginner: :computer: This exercise requires the use of a command line, or "terminal." If you don't know what that means, or if you do but you feel intimidated by that, consider going through [Tech Learning Collective&rsquo;s free, online and self-paced *Foundations: Command Line Basics* course](https://techlearningcollective.com/foundations/), spending an hour at [Apple's Terminal User Guide](https://support.apple.com/guide/terminal/) (for macOS users), [Ubuntu's Command Line for Beginners tutorial](https://ubuntu.com/tutorials/command-line-for-beginners) (for GNU/Linux users) or reviewing [Computer Hope's article, "How to use the Windows command line (DOS)"](http://www.computerhope.com/issues/chusedos.htm) (for Windows users) if you want to get started quickly. You don't need to complete the whole tutorial or article to understand this exercise, but it will dramatically improve your comprehension of this exercise's mechanics. If you want a more thorough but equally gentle introduction to the same material, consider reading (and listening to) [Taming the Terminal](https://www.bartbusschots.ie/s/blog/taming-the-terminal/).

# Set up

In addition to your laptop or desktop computer, you will need to acquire the following tools.

* For managing the virtual machines: [VirtualBox](https://www.virtualbox.org/) version 6.1 or newer, sometimes written as *VBox*.
* For automatically configuring virtual machine settings: [Vagrant](https://vagrantup.com/) version 2.2.7 or newer.

Complete the [Introduction to Virtual Machine Management with Vagrant](../introduction-to-virtual-machine-management-with-vagrant/README.md) practice lab before this one if you do not yet have VirtualBox and Vagrant installed or are unfamiliar with how to use them.

Then, bring the virtual machine(s) for the lab online.

**Do this:**

1. Boot both virtual machines needed for the lab:
    ```sh
    vagrant up
    ```

Once both the virtual machines are running, you can continue to the next step.

# Practice

We'll begin by ensuring you have successfully completed the [set up](#set-up) steps. This process will also introduce the fundamentals that you need to understand to complete the rest of the exercise.

## Introduction

> :construction: TK-TODO
>
> Juice shop is at http://192.168.56.110. Aim OWASP ZAP there.
>
> This section is just notes for the time being.

1. Finding the scoreboard is the first challenge:
    * Manually brute-force the URL, or
    * use the search features in ZAP to find requests with "score board" in them, or
    * use the Site Map pane to view `/api/Challenges/` URL path (i.e., Web app route) to locate the score board.
1. Exploit an authorization bypass vulnerability (also called an [Insecure Direct Object Reference (IDOR)](https://cwe.mitre.org/data/definitions/639.html)) by locating and retrieving a confidential document.
    * Passively spider the application by browsing around as much as possible, then
    * notice the `/ftp` path in the Site Map. Hmm!
    * This isn't so much "broken" authentication as much as it is non-existent (or unimplemented) authentication. Is it "broken" if it doesn't even exist? Perhaps that's one for the philosophers.
1. Now let's exploit a broken access control vuln by accessing another user's shopping basket:
    1. First, we need to have a user account to create a basket, so register one if you haven't already.
    1. Add some items to your own basket.
    1. Using ZAP, explore how the basket functionality is implemented.
    1. See if you can manipulate the LocalStorage of your browser to retrieve another user's basket.
    1. Do the same in ZAP by using its Resend feature or its HTTP interception/breakpointing feature.
1. Another common vuln is SQL injection (SQLi), let's look at how to use this to exploit broken authentication:
    1. Look for some places where the application might be backed by a SQL database such as, say the Login form.
    1. Enter `'` into the email field, note the error.
    1. Compose a SQLi payload that will login with the first account in the database. (E.g., `' or 1=1 -- `)
    1. Have a look at some [SQL cheat sheets](https://github.com/AnarchoTechNYC/CTF/wiki/SQL-Injection) for more info on why this works.
1. Getting a bit more sophisticated with SQL injection, we can use it to pull data *out* of the database, the classic data breach:
    1. Find another SQL-injectable entry point into the database (like `/rest/products/search?q=`).
    1. Go to this API endpoint in your browser and view the JSON there.
    1. Modify the `q` parameter until you trigger a database error, confirming SQL injection vulnerability is present.
    1. This is a product search, so start by imagining what the query is: probably something like `SELECT * FROM sometable WHERE somecolumn LIKE '%'`. <-- That's our injection point.
    1. Now construct a SQL injection payload that will join unexpected data with the existing query in a valid way. (E.g., `')) UNION SELECT * FROM whatever -- `.)
    1. Notice the error suggesting that the `whatever` table doesn't exist.
    1. Modify the query to use a table that does exist. Don't know which tables exist? No worries, just guess. How about `users`? Yup!
    1. Now we need to match the number of columns. So again, we just iterate.
        1. Is it one column? `')) UNION SELECT 1 FROM users -- `
        1. Is it two columns? `')) UNION SELECT 1, 2 FROM users -- `
        1. Is it three columns? `')) UNION SELECT 1,2,3 FROM users -- `
        1. And so on until we get it right. Try at least 20.
    1. Now that we have a working SQL statement, just ask for the data that you actually want instead of the literal values you've entered:
        1. `')) UNION SELECT email, 2, 3, â€¦ FROM users -- ` <-- Make a guess that the `email` field exists in the `users` table and ask for its data instead.
        1. Change `2` to another column that you want, etc.
1. This is slow, so let's automate the process with `sqlmap`, which is purpose-built for SQL injection.
1. Another, more modern, technique used in many Web apps and especially Web APIs is JSON Web Tokens (JWT). Let's again break into the administrator account, but this time using a vulnerability in the JWT implementation rather than the login form directly.
    1. Create any account, then log in to the application.
    1. Notice the `/rest/user/whoami` endpoint; view the request and response to it, and find the JWT in the `Authorization` header or the `token` cookie.
    1. Break the JWT structure down into its constituent parts. JWTs are dot-separated, Base64 URL-safe encoded and contain:
        1. a header, (importantly, listing an algorithm [`"alg"`], which can be `none`),
        1. the token itself (the actual JWT), and
        1. the JSON Web Token's signature (JWS).
    1. Decode the header:
        ```sh
        echo -n "$jwt_encoded_header" | base64 --decode # Or use https://gchq.github.io/CyberChef
        ```
    1. Change the algorithm (probably `RS256`), to `none`. Then, re-encode the header:
        ```sh
        echo -n "$jwt_decoded_header" | base64 | tr -d "\n=" # Be sure to strip trailing `=` and newlines.
        ```
    1. Do the same thing for the JWT content itself, this time replacing `email` and `id` values with an admin account's values:
        * ID: `1`
        * Email: `admin@juice-sh.op`
    1. Recreate the JWT manually by pasting the newly encoded header, a dot (`.`), the newly encoded content, and a trailing dot (`.`); omit the signature, which should be a null string because the algorithm for the JWT is now `none`.
    1. Find a location in the application where such a valid JWT can be used. For example: password change functionality.
    1. Use the OWASP ZAP "Resend" attack ("Manual Request Editor") to use the manually-constructed JWT to change the password of the admin account.
    1. Log in as the admin account with its new password.

# Discussion

> :construction: TK-TODO

# Additional references

> :construction: TK-TODO

* [Troy Hunt's &ldquo;Hack Yourself First&rdquo;](https://hack-yourself-first.com/) intentionally vulnerable demonstration site.
